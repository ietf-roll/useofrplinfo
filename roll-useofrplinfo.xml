<?xml version="1.0"?>
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [

<!ENTITY RFC6550 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6550.xml">
<!ENTITY RFC6553 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6553.xml">
<!ENTITY RFC6554 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.6554.xml">
<!ENTITY RFC2119 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml">
<!ENTITY RFC7102 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.7102.xml">
<!ENTITY I-D.ietf-6lo-routing-dispatch SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-6lo-routing-dispatch.xml">
<!ENTITY I-D.ietf-6tisch-architecture SYSTEM "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.ietf-6tisch-architecture.xml">


]>

<!--<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?> -->
<!-- used by XSLT processors -->
<!-- For a complete list and description of processing instructions (PIs),
    please see http://xml.resource.org/authoring/README.html. -->
<!-- Below are generally applicable Processing Instructions (PIs) that most I-Ds might want to use.
    (Here they are set differently than their defaults in xml2rfc v1.32) -->
<?rfc strict="no" ?>
<!-- give errors regarding ID-nits and DTD validation -->
<!-- control the table of contents (ToC) -->
<?rfc toc="yes"?>
<!-- generate a ToC -->
<?rfc tocdepth="4"?>
<!-- the number of levels of subsections in ToC. default: 3 -->
<!-- control references -->
<?rfc symrefs="yes"?>
<!-- use symbolic references tags, i.e, [RFC2119] instead of [1] -->
<?rfc sortrefs="yes" ?>
<!-- sort the reference entries alphabetically -->
<!-- control vertical white space
    (using these PIs as follows is recommended by the RFC Editor) -->
<?rfc compact="yes" ?>
<!-- do not start each main section on a new page -->
<?rfc subcompact="no" ?>
<!-- keep one blank line between list items -->
<!-- end of list of popular I-D processing instructions -->
<rfc category="info" docName="draft-ietf-roll-useofrplinfo-02" ipr="trust200902">
 <!-- category values: std, bcp, info, exp, and historic
    ipr values: trust200902, noModificationTrust200902, noDerivativesTrust200902,
       or pre5378Trust200902
    you can add the attributes updates="NNNN" and obsoletes="NNNN"
    they will automatically be output with "(if approved)" -->

 <!-- ***** FRONT MATTER ***** -->

 <front>
   <!-- The abbreviated title is used in the page header - it is only necessary if the
        full title is longer than 39 characters -->

  <title abbrev="Useof6553">When to use RFC 6553, 6554 and IPv6-in-IPv6</title>

  <author  initials="M.I." surname="Robles" fullname="Maria Ines Robles">
     <organization abbrev="Ericsson">Ericsson</organization>
    <address>
     <postal>
       <street>Hirsalantie 11</street>
       <city>Jorvas</city>
       <code>02420</code>
       <country>Finland</country>
     </postal>
      <email>maria.ines.robles@ericsson.com</email>
    </address>
  </author>

  <author initials="M." surname="Richardson" fullname="Michael C. Richardson">
    <organization abbrev="SSW">Sandelman Software Works</organization>
     <address>
        <postal>
        <street>470 Dawson Avenue</street>
        <city>Ottawa</city>
        <region>ON</region>
        <code>K1Z 5V7</code>
        <country>CA</country>
        </postal>
        <email>mcr+ietf@sandelman.ca</email>
        <uri>http://www.sandelman.ca/</uri>
     </address>

  </author>
  <author initials="P." surname="Thubert" fullname="Pascal Thubert">
    <organization abbrev="Cisco">Cisco Systems, Inc</organization>
     <address>
        <postal>
        <street> Village d'Entreprises Green Side 400, Avenue de Roumanille</street>
        <city>Batiment T3</city>
        <region>Biot - Sophia Antipolis  </region>
        <code>06410</code>
        <country>France</country>
        </postal>
        <email>pthubert@cisco.com </email>
        <uri></uri>
     </address>

  </author>

  <date year="2016" />

   <area>Internet</area>

   <workgroup>ROLL Working Group</workgroup>

   <keyword>RPL Option</keyword>
   <keyword>6LoWPAN</keyword>
   <keyword>RFC 6553</keyword>

   <abstract>
      <t>
        This document looks at different data flows through LLN networks where RPL is used to establish routing.
        The document enumerates the cases where RFC 6553, RFC 6554 and IPv6-in-IPv6 encapsulation is required. This analysis
        provides the basis on which to design efficient compression of these headers.
     </t>
   </abstract>
 </front>

<middle>
          <section title="Introduction">
             <t>
                RPL <xref target="RFC6550"/> is a routing protocol for
                constrained networks. RFC 6553 <xref target="RFC6553"/>
                defines the "RPL option" (RPI), carried within the IPv6 Hop-by-Hop
                header to                          quickly identify
                inconsistencies (loops) in the routing topology. RFC 6554 <xref
                target="RFC6554"/> defines the "RPL Source Route Header" (RH3), an
                IPv6 Extension Header to deliver datagrams within a RPL
                routing domain, particularly in non-storing mode.
             </t>
             <t>
                These various items are referred to as RPL artifacts, and
                they are seen on all of the data-plane traffic that occurs in
                RPL routed networks; they do not in general appear on the RPL
                control plane traffic at all which is mostly hop-by-hop
                traffic (one exception being DAO messages in non-storing mode).
             </t>
             <t>
               It has become clear from attempts to do multi-vendor
               interoperability, and from a desire to compress as many of
               the above artifacts as possible that not all implementors
               agree when artifacts are necessary, or when they can be safely
               omitted, or removed.
             </t>
             <t>
               An interim meeting went through the 24 cases defined here to
               discover if there were any shortcuts, and this document is the
               result of that discussion.  This document should not be
               defining anything new, but it may clarify what is correct and
               incorrect behaviour.
             </t>
             <t>
               The related document  <xref
                target="I-D.ietf-6lo-routing-dispatch"> A Routing Header
                Dispatch for 6LoWPAN (6LoRH) </xref> defines a method to
                compress RPL Option information and Routing Header type 3
                (RFC6554) and an efficient IP-in-IP technique. Uses cases
                proposed for the <xref target="Second6TischPlugtest"/>
                involving 6loRH.
           </t>
     </section>

     <section title="Terminology and Requirements Language">
        <t>
           The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
           "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
              document are to be interpreted as described
           in <xref target="RFC2119">RFC 2119</xref>.
        </t>
        <t>
        Terminology defined in <xref target="RFC7102"/>
        </t>

       </section>


       <section title="Sample/reference topology">
                <t>
                A RPL network is composed of a 6LBR (6LoWPAN Border Router),
                Backbone Router (6BBR), 6LR (6LoWPAN Router) and 6LN (6LoWPAN
                Node) as leaf logically organized in a DODAG structure
                (Destination Oriented Directed Acyclic Graph).
                     </t>
                <t>
                RPL defines the RPL Control messages (control plane ), a new
                ICMPv6 message with Type 155. DIS, DIO and DAO messages are
                all RPL Control messages but with different Code values.
                     </t>
                <t>
                RPL supports two modes of Downward traffic: in storing mode,
                it is fully stateful or an in non-storing, it is fully source
                routed. A RPL Instance is either fully storing or fully
                non-storing, i.e. a RPL Instance with a combination of
                storing and non-storing nodes is not supported with the
                current specifications.
                     </t>
                <t>
             <figure title="RPL Stack."

                        anchor="fig_RPLStack" align="center">
                <artwork><![CDATA[
+--------------+
| Upper Layers |
|              |
+--------------+
|   RPL        |
|              |
+--------------+
|   ICMPv6     |
|              |
+--------------+
|   IPv6       |
|              |
+--------------+
|   6LoWPAN    |
|              |
+--------------+
|   PHY-MAC    |
|              |
+--------------+


                ]]></artwork></figure>
                 </t>
               <t>
             <figure title="A reference RPL Topology." anchor="fig_CommonTopology" align="center">
                <artwork><![CDATA[

                                 +---------+
                             +---+Internet |
                             |   +---------+
                             |
                        +----+--+
                        |DODAG  |  node:01
              +---------+Root   +----------+
              |         |6LBR   |          |
              |         +----+--+          |
              |              |             |
              |              |             |
             ...            ...           ...
              |              |             |
        +-----+-+         +--+---+      +--+---+
        |6LR    |         |      |      |      |
  +-----+       |         |      |      |      |
  |     |   11  |         |   12 |      |   13 +------+
  |     +-----+-+         +-+----+      +-+----+      |
  |           |             |             |           |
  |           |             |             |           |
  | 21        | 22          | 23          | 24        | 25
+-+---+     +-+---+      +--+--+       +- --+     +---+-+
|Leaf |     |     |      |     |       |Leaf|     |Leaf |
| 6LR |     |     |      |     |       | 6LN|     | 6LR |
+-----+     +-----+      +-----+       +----+     +-----+

                ]]></artwork></figure>
                 </t>
                 <t> The numbers in or above the nodes are there so that
                 they may be referenced in subsequent sections.  The leaf marked 6LN (24) is
                 a device which does not speak RPL at all, but uses Router-Advertisements,
                 6LowPAN DAR/DAC and efficient-ND only to participate in the network.
                 </t>
                <t>
        This document is in part motivated by the work that is ongoing at the
        6TiSCH working group.
             The <xref target="I-D.ietf-6tisch-architecture">6TiSCH architecture
        </xref> draft explains the network architecture of a 6TiSCH network.
        This architecture is used for the remainder of this document.
        </t>
        <t> The scope of the 6TiSCH Architecture is a Backbone Link that
        federates multiple LLNs (mesh) as a single IPv6 Multi-Link Subnet.
                  Each LLN in the subnet is anchored at a Backbone Router (6BBR).
        The Backbone Routers interconnect the LLNs over the Backbone Link and
        emulate that the LLN nodes are present on the Backbone thus creating a
        so-called: Multi-Link Subnet. An LLN node can move freely from an LLN
        anchored at a Backbone Router to another LLN anchored at the same or a
        different Backbone Router inside the Multi-Link Subnet and conserve its
        addresses.
            </t>
                 <t>


<figure anchor='figNetwork'
 title="RPL domain architecture">
<artwork><![CDATA[

               |
            +-----+
            |     | Border Router to the RPL domain
            |     |  (may be a RPL virtual root)
            +-----+
               |
               |          Backbone
         +-------------------+-------------------+
         |                   |                   |
      +-----+             +-----+             +-----+
      |     | Backbone    |     | Backbone    |     | Backbone
      |     | router      |     | router      |     | router
      +|---|+             +-|||-+             +-[_]-+
       |   | PCI-exp       / | \ USB             | Ethernet
      ( ) ( )            ( )( )( )     (6LBR == RPL DODAG root)
     o o   o  o       o o   o  o  o            o  o   o
     o o   o o  o    o  o   o  o  o  o     o   o  o  o   o
    o  o o  o o       o   o  o  o  o     6LR == RPL router) o o
    o   o  o  o          o    o  o             z
    o   o o               o  o   o       (6LoWPAN Host)

    <----------------------- RPL Instance ------------------------>

]]></artwork>
</figure>
                 </t>

       </section>


       <section title="Use cases">
         <t>
           In data plane context a combination of RFC6553, RFC6554 and
           IPv6-in-IPv6 encapsulation is going to be analyzed for the
           following traffic flows:

          <list>
                 <t>
                   RPL-aware-leaf to root
                 </t>
                 <t>
                   root to RPL-aware-leaf
                 </t>
                 <t>
                   not-RPL-aware-leaf to root
                 </t>
                 <t>
                   root to not-RPL-aware-leaf
                 </t>
                 <t>
                   RPL-aware-leaf to Internet
                 </t>
                 <t>
                   Internet to RPL-aware-leaf
                 </t>
                 <t>
                   not-RPL-aware-leaf to Internet
                 </t>
                 <t>
                   Internet to not-RPL-aware-leaf
                 </t>
                 <t>
                   RPL-aware-leaf to RPL-aware-leaf
                 </t>
                 <t>
                   RPL-aware-leaf to not-RPL-aware-leaf
                 </t>
                 <t>
                   not-RPL-aware-leaf to RPL-aware-leaf
                 </t>
                 <t>
                   not-RPL-aware-leaf to not-RPL-aware-leaf
                 </t>
          </list>
         </t>
          <t>
            This document assumes a rule that a Header cannot be inserted or
            removed on the fly inside an IPv6 packet that is being routed.
            This is a fundamental precept of the IPv6 architecture as
            outlined in <xref target="RFC2460" /> is that Extensions may not
            be added or removed except by the sender or the receiver.
          </t>
          <t>
            A second important thing is that packets with a Hop-by-Hop
            option which are marked with option type 01 (<xref
            target="RFC2460" /> section 4.2) must be discarded if received
            by a host or router which does not understand that option.
            This means that in general, any packet that leaves the RPL domain
            of an LLN (or leaves the LLN entirely) is likely to be discarded
            if it still contains an <xref target="RFC6553" /> RPL Option
            Header known as the RPI.
          </t>
          <t>
            The combination of these two rules means that the arrangement
            of headers must be done so that traffic intended to exit the RPL
            domain can have the RPI option removed prior to leaving the RPL
            domain.
          </t>
          <t>
            An intermediate router that needs to add a header must
            encapsulate the packet in an (additional) outer IP header where
            the new header can be placed.
         </t>
          <t>
            This also means that a Header can only be removed by an
            intermediate router if it is placed in an encapsulating IPv6
            Header, and in that case, the whole encapsulating header must be
            removed - a replacement may be added. Further, an intermediate
            router can only remove such an outer header if that outer header
            has the router as the destination!
         </t>
          <t>
            Both RPI and RH3 headers may be modified by routers on the path of the packet
            without the need to add to remove an encapsulating header.  Both
            headers were designed with this modification in mind, and both
            the RPL RH and the RPL option are marked mutable but recoverable,
            so an IPsec AH security header can be applied across these
            headers, but it may not secure all the values in those headers.
         </t>
          <t>
            RPI should be present in every single RPL data packet. There is one
            exception in non-storing mode: when a packet is going down from the
            route.  In a downward non-storing mode, the entire route is
            written, so there can be no loops by construction, nor any
            confusion about which forwarding table to use.  There may be
            cases (such as in 6tisch) where the instanceID may still be
            needed to pick an appropriate priority or channel at each hop.
          </t>
          <t>
            The applicability for storing (RPL-SN) and non-Storing (RPL-NSN)
            modes for the previous cases is showed as follows:
          </t>

          <t>
            In tables, the term "RPL aware leaf" is has been shortened to
            "Raf", and "not-RPL aware leaf" has been shortened to "~Raf" to
            make the table fit in available space.
          </t>

          <t>
            The earlier examples are more complete to make sure that the
            process is clear, while later examples are more consise.
          </t>

        </section>


        <section title=" Storing mode">

          <t>
            This table summarizes what headers are needed in the following
            scenarios, and indicates the IPIP header must be
            inserted on a hop-by-hop basis, and when it can target the
            destination node directly.  There are three possible situations:
            hop-by-hop necessary (indicated by "hop"), or destination address
            possible (indicated by "dst").  In all cases hop by hop can be
            used. In cases where no IPIP header is needed, the column is left blank.
          </t>

         <texttable anchor="table_storing" title="Headers needed in Storing mode: RPI, RH3, IP-in-IP encapsulation" >
           <ttcol> Use Case </ttcol>
           <ttcol> RPI (RFC 6553) </ttcol>
           <ttcol> RH3 (RFC 6554) </ttcol>
           <ttcol> IP-in-IP </ttcol>
           <ttcol> IPIP dst </ttcol>
           <c> Raf to root</c>
           <c> Yes</c>
           <c> No</c>
           <c> No</c>
           <c> -- </c>

           <c> root to Raf</c>
           <c> Yes</c>
           <c> No</c>
           <c> No</c>
           <c> -- </c>

           <c> root to ~Raf</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> hop </c>

           <c> ~Raf to root</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> root </c>

           <c> Raf to Internet</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> root </c>

           <c> Internet to Raf</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> raf </c>

           <c> ~Raf to Internet</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> root </c>

           <c> Internet to ~Raf</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> hop </c>

           <c> Raf to Raf</c>
           <c> Yes</c>
           <c> No</c>
           <c> No</c>
           <c> -- </c>

           <c> Raf to ~Raf</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> hop </c>

           <c> ~Raf to Raf </c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> dst </c>

           <c> ~Raf to ~Raf</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> hop </c>
         </texttable>

               <section title="Example of Flow from RPL-aware-leaf to root">

                        <t>
                         As states in Section 16.2 of <xref
                         target="RFC6550"/>  a RPL-aware-leaf node does not
                         generally issue DIO messages; a leaf node accepts
                         DIO messages from upstream.
                        (When the inconsistency in routing occurs, a leaf
                        node will generate a DIO with an infinite rank, to
                        fix it).  It may issue DAO and DIS
                        messages though it generally ignores DAO and DIS
                        messages.
                        </t>

                        <t>
                        In storing mode, it is suitable to use RFC 6553 (RPI)
                        to send RPL Information instanceID and rank
                        information.
                        </t>

                         <t>
                           In this case the flow comprises:

                        </t>
                        <t>
                        RPL-aware-leaf (6LN) --> 6LR --> 6LR,... --> root
                        (6LBR)
                        </t>
                        <t> Note: In this document 6LRs, 6LBR are always
                        full-fledge RPL routers, and are the RPL root node.
                        </t>
                         <t>
                           The 6LN inserts the RPI header, and send the
                           packet to 6LR which decrement the rank in RPI and
                           send the packet up. When the packet arrives to
                           6LBR, the RPI is removed and the packet is
                           processed.
                         </t>

                         <t> The RPI header can be removed by the 6LBR
                         because the packet is addressed to the 6LBR.  The
                         6LN must know that it is communicating with the 6LBR
                         in order to be able to make use of this scenario.
                         The 6LN can know the address of the 6LBR because it
                         knows the address of the root via the DODAGID in the
                         DIO messages.
                         </t>

                        <texttable title="Storing: Summary of the use of headers from RPL-aware-leaf to root">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <c> Inserted headers</c>
                                          <c> RPI</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> RPI </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> RPI </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> --</c>
                                          <c> --</c>

                        </texttable>
               </section>

               <section title="Example of Flow from root to RPL-aware-leaf">

                         <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                root (6LBR)--> 6LR --> RPL-aware-leaf (6LN)
                        </t>
                        <t>
                                In this case the 6LBR insert RPI header and
                                send the packet down, the 6LR is going to
                                increment the rank in RPI (examines
                                instanceID for multiple tables), the packet
                                is processed in 6LN and RPI removed.
                        </t>
                        <t>
                          No IPIP header is required.
                        </t>

                        <texttable title="Storing: Summary of the use of headers from root to RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <c> Inserted headers</c>
                                          <c> RPI </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> RPI </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> RPI  </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title="Example of Flow from root to not-RPL-aware-leaf">
                        <t>
                        In this case the flow comprises:
                        </t>
                        <t>

                                root (6LBR)--> 6LR --> not-RPL-aware-leaf (6LN)
                        </t>
                        <t>
                          It includes IPv6-in-IPv6 encapsulation to transmit
                          information not related with the RPL domain. In the
                          6LBR the RPI header is inserted into an IPv6-in-IPv6
                          header addressed to the last 6LR, which removes the
                          header before pass the packet to the IPv6 node.
                        </t>
                        <t>
                          The question in this scenario is how the root knows
                          how to address the IPv6-in-IPv6 header.  It can not
                          know that the destination isn't RPL aware, so it
                          must insert an IPv6 that can be removed on the last
                          RPL aware node.  Since the root can not know in a
                          storing network where the last RPL aware node is,
                          the IPv6-in-IPv6 header must added hop-by-hop along
                          the path from root to leaf.
                        </t>
                        <t>
                          An alternative option is to add an attribute in the
                          RPL Target Option to indicate that the target is
                          not RPL aware: future work may explore this possibility.
                        </t>
                        <texttable title="Storing: Summary of the use of headers from root to not-RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <c> Inserted headers</c>
                                          <c> IPIP(RPI)</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI)</c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title="Example of Flow from not-RPL-aware-leaf to root">
                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                not-RPL-aware-leaf (6LN) --> 6LR --> root (6LBR)
                        </t>
                        <t>
                                When the packet arrives from IPv6 node to
                                6LR, the 6LR will insert an RPI header, encapsuladed
                                in a IPv6-in-IPv6 header.  The IPv6-in-IPv6
                                header can be addressed to the next hop, or to
                                the root.  The root removes the header and process
                                the packet.
                        </t>

                        <texttable title="Storing: Summary of the use of headers from not-RPL-aware-leaf to root">
                                          <ttcol> Header</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c>  IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI)</c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title="Example of Flow from RPL-aware-leaf to Internet">
                         <t>
                        RPL information from RFC 6553 should not go out to
                        Internet as it will cause the packet to be discarded
                        at the first non-RPI aware router.
                        The 6LBR must be able to take this information out
                        before sending the packet upwards to the
                        Internet. This requires the RPI header be placed in
                        an IPIP header that the root can remove.
                         </t>
                         <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                RPL-aware-leaf (6LN) --> 6LR --> root (6LBR) --> Internet
                        </t>
                        <t>
                          The 6LN will insert the RPI in a IPv6-in-IPv6 in a outer
                          header, which may be addressed to the 6LBR (root),
                          or alternatively, it could be addressed hop-by-hop.
                        </t>

                        <texttable title="Storing: Summary of the use of headers from RPL-aware-leaf to Internet">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> Internet</ttcol>
                                          <c> Inserted headers</c>
                                          <c> IPIP(RPI)</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI)</c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c>RPI </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <!-- section 5.6 -->
               <section title="Example of Flow from Internet to RPL-aware-leaf">
                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                Internet --> root (6LBR) --> 6LR --> RPL-aware-leaf (6LN)
                        </t>
                        <t>

                                When the packet arrives from Internet to 6LBR
                                the RPI header is added in a outer
                                IPv6-in-IPv6 header and send to 6LR, which
                                modifies the rank in the RPI. When the packet
                                arrives 6LN the RPI header is removed and the
                                packet processed.
                        </t>

                        <texttable title="Storing: Summary of the use of headers from Internet to RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> Internet</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> RPI </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>


               <!-- section 5.6 -->
               <section title="Example of Flow from not-RPL-aware-leaf to Internet">
                 <t>
                   In this case the flow comprises:
                 </t>
                 <t>
                   not-RPL-aware-leaf (6LN) --> 6LR --> root (6LBR) --> Internet
                 </t>
                 <t>
                   The 6LR node will add an IPIP(RPI) header addressed either
                   to the root, or hop-by-hop such that the root can remove
                   the RPI header before passing upwards.
                 </t>
                 <t>
                   The originating node will ideally leave the IPv6 flow
                   label as zero so that it can be better compressed through
                   the LLN, and the 6LBR will set the flow label to a
                   non-zero value when sending to the Internet.
                 </t>

                 <texttable title="Storing: Summary of the use of headers from not-RPL-aware-leaf to Internet">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LN </ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> Internet</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c>IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> --</c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

                       <section title=" Example of Flow from Internet to non-RPL-aware-leaf">
                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                Internet --> root (6LBR) --> 6LR --> not-RPL-aware-leaf (6LN)
                        </t>
                        <t>
                          The 6LBR will have to add an RPI header within an
                          IPIP header. The IPIP will need to be addressed
                          hop-by-hop along the path as in storing mode, the
                          6LBR has no idea if the 6LN is RPL aware or not,
                          nor what the closest attached 6LR node is.
                        </t>
                        <t>
                          The 6LBR MAY set the flow label on the inner IPIP
                          header to zero in order to aid in compression, as
                          the packet will not emerge again from the LLN.
                        </t>
                        <texttable title="Storing: Summary of the use of headers from Internet to non-RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> Internet</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c>  IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c>IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c>-- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <!-- section 5.9 -->
               <section title="Example of Flow from RPL-aware-leaf to RPL-aware-leaf">
                 <t>
                   In <xref target="RFC6550"/> RPL allows a simple one-hop
                   optimization for both storing and non-storing
                   networks.
                   A node may send a packet destined to a one-hop
                   neighbor directly to that node. Section 9 in <xref
                   target="RFC6550"/>.
                 </t>
                 <t>
                   In this case the flow comprises:
                 </t>
                 <t>
                   6LN --> 6LR --> common parent (6LR) --> 6LR -->  6LN
                 </t>
                 <t>
                   This case is assumed in the same RPL Domain. In the
                   common parent, the direction of RPI is changed (from
                   increasing to decreasing the rank).
                 </t>
                 <t>
                   While the 6LR nodes will update the RPI, no node needs to
                   add or remove the RPI, so no IPIP headers are necessary.
                   The ability to do this depends upon the sending know that
                   the destination is: a) inside the LLN, and b) RPL capable.
                 </t>
                 <t>
                   The sender can determine if the destination is inside the
                   LLN by looking if the destination address is matched by
                   the DIO's PIO option.  This check may be modified by the
                   use of backbone routers, but in this case it is assumed
                   that the backbone routers are RPL capable and so can
                   process the RPI header correctly.
                 </t>
                 <t>
                   The other check, that the destination is RPL capable is
                   not currently discernible by the sender.   This
                   information is necessary to distinguish this test case
                   from <xref target="storingraftononraf" />.
                 </t>

                 <texttable title="Storing: Summary of the use of headers for RPL-aware-leaf to RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LN src</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LR (common parent)</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LN dst</ttcol>
                                          <c> Inserted headers</c>
                                          <c> RPI </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> RPI</c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> RPI (decreasing rank) </c>
                                          <c> RPI (increasing rank)</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <!-- section 5.10 -->
               <section anchor="storingraftononraf" title="Example of Flow from RPL-aware-leaf to non-RPL-aware-leaf">
                        <t>
                        In this case the flow comprises:
                        </t>
                        <t>
                         6LN --> 6LR --> common parent (6LR) --> 6LR -->  not-RPL-aware 6LN
                        </t>
                        <t>
                          The sender, being aware out of band, that the
                          receiver is not RPL aware, sends adds an RPI header
                          inside an IPIP header. The IPIP header needs to be
                          addressed on a hop-by-hop basis so that the last
                          6LR can remove the RPI header.
                        </t>
                        <t>
                          <figure anchor='solutionipipeachhop'
                                  title="Solution IPv6-in-IPv6 in each hop">
                            <artwork><![CDATA[

                             ,---.
                            /     \
                           (  6LR2 ) IP3,RPI,IP,ULP
                          ,-"      .
                       ,-"   `---'  `.
                     ,'               `.
           ,---.  ,-"                   `,---.
          /     +"                      /     \
         ( 6LR1  )   Remove the IP3,RPI(  6LR3 )
          \     /                       \     /
           /---'                         `---'|
          /    IP2,RPI,IP,ULP                 \
         /                                     |
        /                                      \
   ,---+-.                                      |
  /       \                                  +--+----+
 (  6LN    )                                 |       |
  \       /                                  |  IPv6 |  IP,ULP
   `-----'                                   |       |
        IP1,RPI,IP,ULP                       +-------+


]]></artwork>
</figure>
                 </t>


                 <t>
                   Alternatively, if the definition of the Option Type field of RPL
                   Option  '01' were changed so that it isn't a "discard
                   if not recognized", then no IPIP header would be
                   necessary.
                   This change is an incompatible on-the-wire change and
                   would require some kind of flag day, possibly a change
                   that is done simultaenously with an updated 6LoRH compress.
                 </t>
                 <texttable title="Storing: Summary of the use of headers from RPL-aware-leaf to not-RPL-aware-leaf">
                   <ttcol> Header</ttcol>
                   <ttcol> 6LN</ttcol>
                   <ttcol> 6LR</ttcol>
                   <ttcol> 6LR (common parent)</ttcol>
                   <ttcol> 6LR</ttcol>
                   <ttcol> IPv6</ttcol>
                   <c> Inserted headers</c>
                   <c> IPIP(RPI) </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> Removed headers</c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c>IPIP(RPI) </c>
                   <c> -- </c>
                   <c> Re-added headers</c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> Modified headers</c>
                   <c> -- </c>
                   <c> IPIP(RPI) </c>
                   <c> IPIP(RPI) </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> Untouched headers</c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                 </texttable>
               </section>

               <section title="Example of Flow from not-RPL-aware-leaf to RPL-aware-leaf">
                 <t>
                   In this case the flow comprises:
                 </t>
                 <t>
                   not-RPL-aware 6LN --> 6LR --> common parent (6LR) --> 6LR -->  6LN
                 </t>
                 <t>
                   The 6LR receives the packet from the the IPv6 node and
                   inserts
                   and the RPI header encapsulated in IPv6-in-IPv6 header.
                   The IPIP header could be addresses to the 6LN if the
                   destination is known to the RPL aware, otherwise must send
                   the packet using a hop-by-hop IPIP header.
                   Similar considerations apply from section <xref target="storingraftononraf" />.
                 </t>
                 <texttable title="Storing: Summary of the use of headers from not-RPL-aware-leaf to RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> common parent (6LR)</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> --</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from not-RPL-aware-leaf to not-RPL-aware-leaf">
                 <t>
                   In this case the flow comprises:
                 </t>
                 <t>
                   not-RPL-aware 6LN (IPv6 node)--> 6LR --> root (6LBR) --> 6LR --> not-RPL-aware 6LN (IPv6 node)
                 </t>
                 <t>
                   This flow combines the problems of the two previous
                   sections.  There is no choice at the first 6LR: it must
                   insert an RPI, and to do that it must add an IPIP header.
                   That IPIP header must be addressed on a hop-by-hop basis.
                 </t>
                 <texttable title="Storing: Summary of the use of headers from not-RPL-aware-leaf to not-RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> IPv6 src</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LR (common parent)</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> IPv6 dst</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c>IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c>IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>
       </section>


       <section title="Non Storing mode">

         <texttable anchor="table_nonstoring" title="Headers needed in Non-Storing mode: RPI, RH3, IP-in-IP encapsulation" >
           <ttcol> Use Case </ttcol>
           <ttcol> RPL-NSN RPI </ttcol>
           <ttcol> RPL-NSN RH3 </ttcol>
           <ttcol> RPL-NSN IP-in-IP </ttcol>
           <c> Raf to root</c>
           <c> Yes</c>
           <c> No</c>
           <c> No</c>
           <c> root to Raf</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> No</c>
           <c> ~Raf to root</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> root to ~Raf</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Raf to Internet</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> Internet to Raf</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> ~Raf to Internet</c>
           <c> Yes</c>
           <c> No</c>
           <c> Yes</c>
           <c> Internet to ~Raf</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Raf to Raf</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Raf to ~Raf</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> ~Raf to Raf </c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> ~Raf to ~Raf</c>
           <c> Yes</c>
           <c> Yes</c>
           <c> Yes</c>
         </texttable>


               <section title=" Example of Flow from RPL-aware-leaf to root">
                         <t>
                        In non-storing mode the leaf node uses Hop-By-Hop
                        option (RFC 6553) to indicate the routing information
                        to send messages to the DODAG root,
                        this message is going to be analyzed in each node until arrive the DODAG root.
                        </t>

                         <t>
                        In this case  not need to use IPv6-in-IPv6 because no
                        header is not going to be removed, neither RH3, the
                        flow comprises:

                        </t>
                        <t>
                        RPL-aware-leaf (6LN) --> 6LR --> root (6LBR)
                        </t>
                        <t>

                        This case is the same case as storing mode.
                         </t>

                        <texttable title="Non Storing: Summary of the use of headers from RPL-aware-leaf to root">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <c> Inserted headers</c>
                                          <c> RPI</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> RPI </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> RPI </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>

                        </texttable>
               </section>

               <section title=" Example of Flow from root to RPL-aware-leaf">

                         <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                root (6LBR)--> 6LR --> RPL-aware-leaf (6LN)
                        </t>
                        <t>
                                6LBR might instert RPI header, and the rute
                                is indicated in RH3. 6LR updated RH3 and 6LN
                                remove these headers.

                        </t>

                        <texttable title="Non Storing: Summary of the use of headers from root to RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <c> Inserted headers</c>
                                          <c> (optional: RPI), RH3</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> RH3,RPI </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c>RH3 </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from root to not-RPL-aware-leaf">
                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                root (6LBR)--> 6LR --> not-RPL-aware-leaf (IPv6 node)
                        </t>
                        <t>

                                In 6LBR the RH3 is added, and modified in 6LR where is fully consumed, but left there.
                                If the RPI is present, the IPv6 node which
                                does not understand it will drop it. To avoid
                                it the RPI should be removed before reach
                                IPv6 node or it is recommended that RPI be
                                omitted. An IPv6-in-IPv6 header should be
                                necessary in this case. The DAO from 6LR
                                about IPv6 could say if that the final IPv6
                                is not RPL (RPI) capable.
                         </t>

                               <texttable title=" Non Storing: Summary of the use of headers from root to not-RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <c> Inserted headers</c>
                                          <c> RH3</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c>RH3</c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from not-RPL-aware-leaf to root">
                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                IPv6-node --> 6LR1 --> 6LR2 --> root (6LBR)
                        </t>
                        <t>

                                In this case the RPI is encapsulated in the first 6LR, and is not modified in the followings 6LRs.
                        </t>

                        <texttable title="Non Storing: Summary of the use of headers from not-RPL-aware-leaf to root">
                                          <ttcol> Header</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <ttcol> 6LR1</ttcol>
                                          <ttcol> 6LR2</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from RPL-aware-leaf to Internet">
                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                RPL-aware-leaf (6LN) --> 6LR --> root (6LBR) --> Internet
                        </t>
                        <t>
                                This case requires that the network is
                                awareness of what is external to the
                                LLN. Internet node never sees RPI or
                                IPv6-in-IPv6 header. In the 6LBR the flow
                                label is computed if it is zero. RPI remains
                                unmodified.
                        </t>

                        <texttable title="Non Storing: Summary of the use of headers from RPL-aware-leaf to Internet">
                          <ttcol> Header</ttcol>
                          <ttcol> 6LN</ttcol>
                          <ttcol> 6LR</ttcol>
                          <ttcol> 6LBR</ttcol>
                          <ttcol> Internet</ttcol>
                          <c> Inserted headers</c>
                          <c> IPIP(RPI)</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Removed headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> IPIP(RPI) </c>
                          <c> -- </c>
                          <c> Re-added headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Modified headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Untouched headers</c>
                          <c> -- </c>
                          <c> RPI </c>
                          <c> -- </c>
                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from Internet to RPL-aware-leaf">
                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                Internet --> root (6LBR) --> 6LR --> RPL-aware-leaf (6LN)
                        </t>
                        <t>
                                 If the last RH3 entry is the 6LR, then the
                                 IPv6-in-IPv6 will be removed there, if the
                                 last entry is the 6LN, then the RH3 will go
                                 all the way to the leaf. In 6LBR the flow
                                 label should be set to zero.
                        </t>

                        <texttable title="Non Storing: Summary of the use of headers from Internet to RPL-aware-leaf">
                          <ttcol> Header</ttcol>
                          <ttcol> Internet</ttcol>
                          <ttcol> 6LBR</ttcol>
                          <ttcol> 6LR</ttcol>
                          <ttcol> 6LN</ttcol>
                          <c> Inserted headers</c>
                          <c> -- </c>
                          <c>  IPIP(RH3,opt:RPI)  </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Removed headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> IPIP(RH3) </c>
                          <c> -- </c>
                          <c> Re-added headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Modified headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> IPIP(RH3) </c>
                          <c> -- </c>
                          <c> Untouched headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from not-RPL-aware-leaf to Internet">

                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                not-RPL-aware-leaf (6LN) --> 6LR --> root (6LBR) -->  Internet
                        </t>
                        <t>
                                In this case the flow label is recommended to
                                be zero in the IPv6 node. no RPL headers are
                                added in the IPv6 node, since it is ignorant
                                of RPL. Internet node does not see special
                                headers. In 6LBR the flow label is computed
                                if it is zero.
                        </t>

                        <texttable title="Non Storing: Summary of the use of headers from not-RPL-aware-leaf to Internet">
                                          <ttcol> Header</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> Internet</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI)</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from Internet to non-RPL-aware-leaf">

                        <t>
                                In this case the flow comprises:
                        </t>
                        <t>

                                Internet --> root (6LBR) --> 6LR --> not-RPL-aware-leaf (6LN)
                        </t>
                        <t>
                                In this case the flow label in 6LBR should be
                                set zero in 6LBR, where RH3 is inserted and
                                optionally RHI. RH3 must end at 6LR.

                        </t>
                        <t>
                                In Non-Storing mode, root knows that the
                                non-RPL-aware-leaf is attached to the parent
                                6LR, and builds RH3 with IPv6-in-IPv6 with
                                this 6LR as destination.

                        </t>

                        <texttable title=" NonStoring: Summary of the use of headers from Internet to non-RPL-aware-leaf">
                          <ttcol> Header</ttcol>
                          <ttcol> Internet</ttcol>
                          <ttcol> 6LBR</ttcol>
                          <ttcol> 6LR</ttcol>
                          <ttcol> IPv6</ttcol>
                          <c> Inserted headers</c>
                          <c> -- </c>
                          <c> IPIP(RH3,opt:RPI) </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Removed headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c>  IPIP(RH3, RPI) </c>
                          <c> -- </c>
                          <c> Re-added headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Modified headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> Untouched headers</c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from RPL-aware-leaf to RPL-aware-leaf">
                        <t>
                        In this case the flow comprises:
                        </t>
                        <t>
                         6LN --> 6LR --> root (6LBR) --> 6LR -->  6LN
                        </t>
                        <t>
                        This case comprises in the same RPL Domain. In the
                        6LN the RPI header is inserted. In the 6LBR the RH3
                        header is inserted in a IPv6-in-IPv6 header and
                        removed at the 6LN destination.
                        </t>
<t>
                        In case of the flow goes from RPL-aware-Leaf to
                        RPL-aware-Leaf, the RPI should be set in a IP-in-IP
                        header, to avoid repetition of RPI header.
</t>

                 <t>
                   Networks that use the RPL P2P extension <xref target="RFC6997" />
                   are essentially non-storing DODAGs and fall into this
                   scenario.
                 </t>


                 <texttable title="Non Storing: Summary of the use of headers for RPL-aware-leaf to RPL-aware-leaf">
                   <ttcol> Header</ttcol>
                   <ttcol> 6LN src</ttcol>
                   <ttcol> 6LBR</ttcol>
                   <ttcol> 6LR</ttcol>
                   <ttcol> 6LN dst</ttcol>
                   <c> Inserted headers</c>
                   <c> IPIP(RPI) </c>
                   <c> IPIP(RH3 to 6LN,RPI) </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> Removed headers</c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> IPIP(RH3,RPI)</c>
                   <c> Re-added headers</c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> Modified headers</c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> Untouched headers</c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                   <c> -- </c>
                 </texttable>
               </section>

               <section title=" Example of Flow from RPL-aware-leaf to not-RPL-aware-leaf">
                        <t>
                        In this case the flow comprises:
                        </t>
                        <t>
                         6LN --> 6LR --> root (6LBR) --> 6LR -->  not-RPL-aware 6LN
                        </t>
                        <t>
                        The 6LN insert the RPI in a IPv6-in-IPv6 header,
                        which is addressed to 6LBR. The 6LBR remove this RPI
                        header and insert a RH3 header with an optional
                        RPI. These headers are removed by 6LR before send the
                        packet to the IPv6 node.
                        </t>

                                       <texttable title="Non Storing: Summary of the use of headers from RPL-aware-leaf to not-RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <c> Inserted headers</c>
                                          <c> IPIP(RPI) </c>
                                          <c>  IPIP(RH3, opt RPI) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> IPIP(RH3, opt RPI) </c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from not-RPL-aware-leaf to RPL-aware-leaf">

                        <t>
                        In this case the flow comprises:
                        </t>
                        <t>
                         not-RPL-aware 6LN --> 6LR --> root (6LBR) --> 6LR -->  6LN
                        </t>
                        <t>
                         RPI is added in 6LR until the root and then removed, then RH3 is added and removed at destination.
                        </t>

                                <texttable title="Non Storing: Summary of the use of headers from not-RPL-aware-leaf to RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LN</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> IPIP(RH3)</c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> -- </c>
                                          <c> IPIP(RH3) </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
               </section>

               <section title=" Example of Flow from not-RPL-aware-leaf to not-RPL-aware-leaf">

                        <t>
                        In this case the flow comprises:
                        </t>
                        <t>
                         not-RPL-aware 6LN --> 6LR --> root (6LBR) --> 6LR --> not-RPL-aware 6LN
                        </t>
                        <t>
                         RPI is added in 6LR until the root and then might be
                         removed, then RH3 is added. These headers are
                         removed at 6LR before go to destination.
                        </t>
                                <texttable title="Non Storing: Summary of the use of headers from not-RPL-aware-leaf to not-RPL-aware-leaf">
                                          <ttcol> Header</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> 6LBR</ttcol>
                                          <ttcol> 6LR</ttcol>
                                          <ttcol> IPv6</ttcol>
                                          <c> Inserted headers</c>
                                          <c> -- </c>
                                          <c>  IPIP(RPI) </c>
                                          <c>  IPIP(RH3) </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Removed headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> IPIP(RPI) </c>
                                          <c> IPIP(RH3, opt RPI) </c>
                                          <c> -- </c>
                                          <c> Re-added headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Modified headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> Untouched headers</c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                                          <c> -- </c>
                        </texttable>
                       </section>

       </section>

       <section title="Observations about the problem">
         <section title="Storing mode">
          <t>
            In the completely general storing case, which includes not-RPL
            aware leaf nodes, it is not possible for a sending node to know
            if the destination is RPL aware, and therefore it must always use
            hop-by-hop IPIP encapsulation, and it can never omit the IPIP
            encapsulation.  See table <xref target="table_storing" />
          </t>
          <t>
            The simplest fully general sitaution is to always put in
            hop-by-hop IPIP headers.  <xref
            target="I-D.ietf-roll-routing-dispatch" /> shows that this
            hop-by-hop IPIP header can be compressed down to {TBD} bytes.
          </t>
          <t>
            There are potential significant advantages to having a single
            code path that always processes IPIP headers with no options.
          </t>

          <t>
            If all RPL aware nodes can be told/configured that there are no
            non-RPL aware leaf nodes, then the only case where an IPIP header
            is needed is when communicating outside the LLN.  The 6LBR knows
            well when the communication is from the outside, and the 6LN
            can tell by comparing the destination address to the prefix
            provided in the PIO.  If it is known that there are no
            communications outside the RPL domain (noting that the RPL domain
            may well extend to outside the LLN), then RPI headers can be
            included in all packets, and IPIP headers are *never* needed.
            This may be significantly advantageous in relatively closed
            systems such as in building or industrial automation.
            Again, there are advantages to having a single code path.
          </t>

          <t>
            In order to support the above two cases with full generality, the
            different situations (always do IPIP vs never use IPIP) should be
            signaled in the RPL protocol itself.
          </t>
         </section>

          <t>
            In order to support the above two cases with full generality, the
            different situations (always do IPIP vs never use IPIP) should be
            signaled in the RPL protocol itself.
          </t>
        </section>


        <section title="6LoRH Compression cases">
           <t>
              The <xref target="I-D.ietf-6lo-routing-dispatch"/> proposes a compression method for RPI, RH3 and IPv6-in-IPv6.
           </t>
           <t>
             In Storing Mode, for the examples of Flow from RPL-aware-leaf to
             non-RPL-aware-leaf and non-RPL-aware-leaf to non-RPL-aware-leaf
             comprise an IP-in-IP and RPI compression headers. The type of
             this case is critical since IP-in-IP is encapsulating a RPI
             header.
           </t>
           <t>

<figure title="Critical IP-in-IP (RPI)." anchor="rtghc"><artwork><![CDATA[

+--+-----+---+--------------+-----------+-------------+-------------+
|1 | 0|0 |TSE| 6LoRH Type 6 | Hop Limit | RPI - 6LoRH | LOWPAN IPHC |
+--+-----+---+--------------+-----------+-------------+-------------+

]]></artwork></figure>

           </t>
      </section>

        <section title="IANA Considerations">
           <t>
              There are no IANA considerations related to this document.
           </t>
        </section>

        <section anchor="Security" title="Security Considerations">
           <t>
         The security considerations covering of <xref target="RFC6553"/> and
         <xref target="RFC6554"/> apply when the packets get into RPL
         Domain.
          </t>
        </section>

        <section anchor="Acknowledgments" title="Acknowledgments">
           <t>
           This work is partially funded by the FP7 Marie Curie Initial Training
           Network (ITN) METRICS project (grant agreement No.  607728).
           </t>
           <t>
           The authors would like to acknowledge the review, feedback, and
           comments of Thomas Watteyne, Xavier Vilajosana, Robert Cragie and Simon Duquennoy.</t>
         </section>


</middle>

 <back>

   <references title="Normative References">


     <!--?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml"?-->

     &RFC6553;
     &RFC6554;
     &RFC2119;
     <?rfc include="reference.RFC.2460" ?>

     &RFC6550;
   </references>

   <references title="Informative References">
   <!--?rfc include="http://xml.resource.org/public/rfc/bibxml/reference.RFC.2119.xml"?-->
     &RFC7102;
     &I-D.ietf-6tisch-architecture;
     &I-D.ietf-6lo-routing-dispatch;
     <?rfc include="reference.RFC.6997" ?>

        <reference anchor="Second6TischPlugtest" target="http://www.ietf.org/mail-archive/web/6tisch/current/pdfgDMQcdCkRz.pdf">
          <front>
            <title>2nd 6Tisch Plugtest </title>
            <author/>
            <date/>
          </front>
             </reference>
     </references>


   <!-- Change Log
v00 2011-03-07  BPa  Initial version

     -->
 </back>
</rfc>
